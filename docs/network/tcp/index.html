<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-network/tcp">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">TCP | iiLsss</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://iilsss.github.io//docs/network/tcp"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="TCP | iiLsss"><meta data-rh="true" name="description" content="TCP&amp;UDP 是运输层两个主要协议。根据所使用的的协议是 TCP 或 UDP，分别称之为 TCP 报文段或 UDP 用户数据报"><meta data-rh="true" property="og:description" content="TCP&amp;UDP 是运输层两个主要协议。根据所使用的的协议是 TCP 或 UDP，分别称之为 TCP 报文段或 UDP 用户数据报"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://iilsss.github.io//docs/network/tcp"><link data-rh="true" rel="alternate" href="https://iilsss.github.io//docs/network/tcp" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://iilsss.github.io//docs/network/tcp" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="iiLsss RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="iiLsss Atom Feed"><link rel="stylesheet" href="/assets/css/styles.28aaf335.css">
<link rel="preload" href="/assets/js/runtime~main.8769d743.js" as="script">
<link rel="preload" href="/assets/js/main.44404fa1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">地球</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro/">Note</a><a class="navbar__item navbar__link header-react-link" href="/docs/react/">React</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">More</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/interview/">📙 知识体系</a></li><li><a class="dropdown__link" href="/tool">🛠️ 工具</a></li></ul></div><a href="https://github.com/iiLsss/iiLsss.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro/">👋 Welcome!</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/network">计算机网络</a><button aria-label="打开/收起侧边栏菜单「计算机网络」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/network/tcp">TCP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/network/http">HTTP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/network/dns">DNS</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/js">Javascript</a><button aria-label="打开/收起侧边栏菜单「Javascript」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/micro">微前端</a><button aria-label="打开/收起侧边栏菜单「微前端」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/algorithm">数据结构与算法</a><button aria-label="打开/收起侧边栏菜单「数据结构与算法」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/media">音视频</a><button aria-label="打开/收起侧边栏菜单「音视频」" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>TCP&amp;UDP</h1><p>TCP&amp;UDP 是运输层两个主要协议。根据所使用的的协议是 TCP 或 UDP，分别称之为 TCP 报文段或 UDP 用户数据报</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="udp">UDP<a class="hash-link" href="#udp" title="标题的直接链接">​</a></h2><p><strong>用户数据报协议 UDP</strong>：在传送数据之前不需要先建立连接。特点如下：</p><ul><li>无连接的</li><li>尽最大努力交付</li><li>面向报文</li><li>没有拥塞控制</li><li>支持一对一、一对多、多对一和多对多的交互通信</li><li>首部开销小，只有 8 个字节，比 TCP 的 20 个字节的首部要断</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tcp">TCP<a class="hash-link" href="#tcp" title="标题的直接链接">​</a></h2><p><strong>传输控制协议 TCP</strong>: 提供面向连接的服务。特点如下：</p><ul><li>面向连接</li><li>点对点</li><li>可靠交付</li><li>双全工通信</li><li>面向字节流</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="重传机制">重传机制<a class="hash-link" href="#重传机制" title="标题的直接链接">​</a></h3><p>在 TCP 中，当发送端的数据到达接收主机是，接收端主机会返回一个确认应答的消息，表示已收到消息。如何在错综复杂的网络，保证正常的数据传输？
TCP 针对数据包丢失的情况，会用重传机制解决。</p><ul><li>超时重传：在发送数据是，设定一个定时器，当超过指定时间后，没有收到对方的 ACK 确认应答报文，就会重发该数据</li><li>快速重传：当收到三个相同的 ACK 报文时，会在定时器过期之前，重传丢失的报文</li><li>SACK：在 TCP 头部选项字段里加一个 SACK，它可以缓存的地图发送给发送方，这样发送方就知道那些数据没接到，就可以重传丢失的数据</li><li>D-SACK：主要使用了 SACK 告诉发送方有哪些数据被重复接收了</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="滑动窗口">滑动窗口<a class="hash-link" href="#滑动窗口" title="标题的直接链接">​</a></h3><p>TCP 是全双工的，所有发送端有发送缓存区，接收端有接收缓存区。发送方在等到确认应答返回之前，必须在缓冲区保留已发送的数据。如果按期收到应答，此时数据就可以从缓存区清除</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="流量控制">流量控制<a class="hash-link" href="#流量控制" title="标题的直接链接">​</a></h3><p>让发送方的发送速率不要太快，要让接收方来得及接收。TCP 提供了一种机制可以让发送方根据接收方的实际接收能力控制发送的数据量。</p><p>在建立连接时，接收端会告诉发送端自己的窗口大小(rwnd)，每次接收端收到数据后都会再次确认(rwnd)大小。如果值为 0，停止发送数据。此时会出现死锁现象。为避免此问题，TCP 会为每个连接设有一个持续定时器，只要 TCP 连接一方收到对方的零窗口通知，就启动持续计时器。如果持续计时器超时，就会发送窗口探测报文。</p><p>{/<em> 如果接收方腾出几个字节并告诉发送方现在有几个字节的窗口，而发送方会义无反顾的发送这几个字节，这就是糊涂窗口综合症。 </em>/}</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="拥塞控制">拥塞控制<a class="hash-link" href="#拥塞控制" title="标题的直接链接">​</a></h3><p>防止过多的数据注入网络中，这样可以使网络汇总的路由器或链路不至过载。</p><p>拥塞窗口 cwnd：发送方维护的一个状态变量，根据网络的拥塞程度动态变化的，只要发送方没有在规定时间内接收到 ACK 应答报文，也就是发送了<strong>超时重传</strong>，就会认为网络出现了拥塞。将窗口变小。<strong>发送方让自己的发送窗口等于拥塞窗口</strong></p><p>拥塞控制主要四个算法：</p><ul><li>慢启动：当发送方开始发送数据时，由小到大逐渐增大发送窗口，也就是说，<strong>由小到大逐渐增大拥塞窗口数值</strong><ul><li>当发送方每收到一个 ACK，拥塞窗口 cwnd 的大小就会加 1</li></ul></li><li>拥塞避免：当拥塞窗口 cwnd 超过慢启动门限 ssthresh 就会进行拥塞避免算法。将原本的慢启动算法的指数增长变成了线性增长<ul><li>每接收一个 ACK 时，cwnd 增加 1/cwnd</li></ul></li><li>拥塞发生：当网络出现拥塞，也就是发生数据包重传，重传机制主要有两种：超时重传、快速重传<ul><li>发生超时重传，将 ssthresh 设为 cwnd/2 cwnd 重置为 1</li></ul></li><li>快速恢复：一般与快速重传同时使用，快速恢复算法认为，还能收到三个重复 ACK 说明网络没有那么糟糕，所以没有必要向超时那么强烈<ul><li>cwnd 设置 cwnd/2， ssthresh = cwnd</li></ul></li></ul><p><strong>ssthresh 慢启动门限</strong></p><ul><li>cwnd &lt; ssthresh(慢启动门限) 使用慢开始算法</li><li>cwnd &gt; ssthresh 使用拥塞避免算法</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="连接管理">连接管理<a class="hash-link" href="#连接管理" title="标题的直接链接">​</a></h3><p>TCP 是面向连接的协议。TCP 运输连接的建立和释放是每一次面向连接的通信必不可少的过程。因此，运输连接就有三个阶段，即：<strong>连接建立</strong>、<strong>数据传送</strong>和<strong>连接释放</strong>。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tcp-连接的建立三次握手">TCP 连接的建立（三次握手）<a class="hash-link" href="#tcp-连接的建立三次握手" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="/assets/images/tcp-three-83858df4b827dccfc60f805b8dfc2eea.png" width="1124" height="614" class="img_ev3q"></p><ul><li>最初，客户端 A 和服务端 B 的 TCP 进程都是处于 CLOSE(关闭)状态。一开始服务端 B 准备接收客户进程的连接请求，处于 LISTEN(收听)状态，等待客户的连接请求。</li><li>客户端 A 向 B 发出连接请求报文段，这是首部中的同步位 SYN = 1，同时选择一个初始序号 seq=x。客户进程进入 SYN-SENT(同步已发送)状态。</li><li>B 收到连接请求报文段后，如同意连接，则向 A 发送确认。在确认报文段中应把 SYN 位和 ACK 位都置 1，确认号是 ack = x + 1，同时也为自己选择一个初始序号 seq=y。服务端进程进入 SYN-RCVD(同步收到)状态。</li><li>A 收到 B 的确认后，还要向 B 给出确认。确认报文段的 ACK 置 1，确认号 ack = y +1，而自己的序号 seq = x + 1。这是 TCP 连接已建立，A 也进入 ESTABLISHED(已建立连接)状态。</li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>注意</div><div class="admonitionContent_S0QG"><p>TCP 规定，SYN 报文段(即 SYN=1 的报文段)不能携带数据。因此前两次握手是不允许携带数据。第三次握手可以携带数据</p></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="三次握手的原因">三次握手的原因<a class="hash-link" href="#三次握手的原因" title="标题的直接链接">​</a></h5><ul><li>为了防止旧的重复连接初始造成混乱是<strong>首要原因</strong></li><li>避免资源浪费</li><li>同步双发初始化序列号</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tcp-连接断开">TCP 连接断开<a class="hash-link" href="#tcp-连接断开" title="标题的直接链接">​</a></h4><p><img loading="lazy" src="/assets/images/tcp-four-9842fe2130693fd4c147b2d833e598b9.png" width="1144" height="755" class="img_ev3q"></p><ul><li>数据传输结束后，双方都可以释放连接。客户端 A 打算关闭，发送报文段 FIN=1 seq=u，进入 FIN-WAIT-1 状态，等待 B 确认</li><li>B 收到断开报文后发出确认，ack = u + 1，进入 CLOSE-WATI 状态。</li><li>A 收到 B 的确认，进入 FIN-WAIT-2 状态，等待 B 发出的连接释放报文段。</li><li>若 B 没有要向 A 发送的数据，发送报文段 FIN=1，ack = u + 1，进入 LSAT-ACK 状态</li><li>A 收到 B 的连接释放报文段后，对此发去确认。ACK=1,seq=w+1,seq=u+1。进入 TIME-WAIT 状态。等待 2MSL 计时器</li><li>B 收到了 A 的确认，进入 CLOSE 状态</li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="四次挥手的原因">四次挥手的原因<a class="hash-link" href="#四次挥手的原因" title="标题的直接链接">​</a></h5><ul><li>关闭连接是，客户端向服务端发送 FIN 时，仅仅表示客户端不在发送数据了但是还能接受数据</li><li>服务端接收客户端的 FIN 报文时，先回一个 ACK 应答报文，而服务端可能还有数据需要处理和发送，等服务端不在发送数据时，才发送 FIN 报文给客户端来表示同意现在关闭连接</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/计算机网络">计算机网络</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/tcp">TCP</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/network"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">网络模型（OSI 七层模型）</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/network/http"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">HTTP</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#udp" class="table-of-contents__link toc-highlight">UDP</a></li><li><a href="#tcp" class="table-of-contents__link toc-highlight">TCP</a><ul><li><a href="#重传机制" class="table-of-contents__link toc-highlight">重传机制</a></li><li><a href="#滑动窗口" class="table-of-contents__link toc-highlight">滑动窗口</a></li><li><a href="#流量控制" class="table-of-contents__link toc-highlight">流量控制</a></li><li><a href="#拥塞控制" class="table-of-contents__link toc-highlight">拥塞控制</a></li><li><a href="#连接管理" class="table-of-contents__link toc-highlight">连接管理</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/iiLsss/iiLsss.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 地球, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8769d743.js"></script>
<script src="/assets/js/main.44404fa1.js"></script>
</body>
</html>