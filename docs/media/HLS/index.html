<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-media/HLS">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">HLS | iiLsss</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://iilsss.github.io//docs/media/HLS"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="HLS | iiLsss"><meta data-rh="true" name="description" content="HLS，全称HTTP Live Streaming，是苹果公司实现基于HTTP的流媒体传输协议。它可以支持流媒体的直播和点播，主要应用在IOS系统和HTML5网页播放器。"><meta data-rh="true" property="og:description" content="HLS，全称HTTP Live Streaming，是苹果公司实现基于HTTP的流媒体传输协议。它可以支持流媒体的直播和点播，主要应用在IOS系统和HTML5网页播放器。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://iilsss.github.io//docs/media/HLS"><link data-rh="true" rel="alternate" href="https://iilsss.github.io//docs/media/HLS" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://iilsss.github.io//docs/media/HLS" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="iiLsss RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="iiLsss Atom Feed"><link rel="stylesheet" href="/assets/css/styles.28aaf335.css">
<link rel="preload" href="/assets/js/runtime~main.8769d743.js" as="script">
<link rel="preload" href="/assets/js/main.44404fa1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">地球</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro/">Note</a><a class="navbar__item navbar__link header-react-link" href="/docs/react/">React</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">More</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/interview/">📙 知识体系</a></li><li><a class="dropdown__link" href="/tool">🛠️ 工具</a></li></ul></div><a href="https://github.com/iiLsss/iiLsss.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro/">👋 Welcome!</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/network">计算机网络</a><button aria-label="打开/收起侧边栏菜单「计算机网络」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/js">Javascript</a><button aria-label="打开/收起侧边栏菜单「Javascript」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/micro">微前端</a><button aria-label="打开/收起侧边栏菜单「微前端」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/algorithm">数据结构与算法</a><button aria-label="打开/收起侧边栏菜单「数据结构与算法」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/media">音视频</a><button aria-label="打开/收起侧边栏菜单「音视频」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/media/HLS">HLS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/media/FLV">FLV</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/media/WebRTC">WebRTC</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>HLS</h1><p>HLS，全称HTTP Live Streaming，是苹果公司实现基于HTTP的流媒体传输协议。它可以支持流媒体的直播和点播，主要应用在IOS系统和HTML5网页播放器。</p><p>HLS的基本原理非常简单，他是将多媒体文件或直接流文件进行切片，形成一堆的ts文件和m3u8索引文件并保存到磁盘，</p><p>当播放器获取HLS流时，他首先根据时间戳，通过HTTP服务，从m3u8索引文件获取最新的ts视频文件切片地址，然后在通过HTTP协议将它们下载并缓存起来。当播放器播放HLS流时，播放线程会从缓存区中读取数据并进行播放。</p><p>通过上面的描述可以知道，<strong>HLS协议的本质就是通过HTTP下载文件，然后将下载的切片缓存起来</strong>。由于切片文件都非常小，所以可以实现边下载边播的效果。HLS规范规定，播放器至少下载一个ts切片才能播放，所以HLS理论上至少会有一个切片的延迟。</p><p><strong>优势：</strong></p><p>HLS是为了解决RTMP协议中存在的一些问题而设计的，所以它自然有自己的优化。主要体现在一下几个方面：</p><ul><li>RTMP协议没有使用标准的HTTP接口传输数据，在一些有访问限制的网络环境下，比如企业网防火墙，是没法访问外网的，因为企业内部一般只允许80/443端口可以访问访网。而HLS使用的是HTTP协议传输数据，所以HLS协议天然就解决了这个问题。</li><li>HLS协议本身实现了码率自适应，不同带宽的设备可以自动切换到最适合自己码率的视频进行播放。</li><li>浏览器天然支持HLS协议，而RTMP协议需要安装Flash插件才能播放RTMP流。</li></ul><p><strong>不足：</strong></p><p>HLS最主要的问题就是<strong>实时性差</strong>。由于HLS往往采用10s的切片，所以最小也要有10s的延迟，一般是20~30s的延迟，有时甚至更差。</p><p>HLS之所以能达到20~30s的延迟，主要是由于HLS的实现机制造成的。HLS使用的是HTTP短连接，且HTTP是基于TCP的，所以就意味着HLS需要不断地与服务器建立连接。TCP每次建立连接时都要进行三次握手，而断开连接时，也要进行四次挥手，基于以上复杂的原因，就造成了HLS延迟比较久的局面。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hls直播架构">HLS直播架构<a class="hash-link" href="#hls直播架构" title="标题的直接链接">​</a></h2><p><img loading="lazy" src="/assets/images/hls-flow-d9fa66834bb099869c81c9ac808c2315.png" width="1344" height="945" class="img_ev3q">
推流 -&gt; 源节点 -&gt; m3u8 -&gt; .ts  -&gt; 用户</p><p>客户端采集媒体数据后，通过RTMP协议将音视频流推送给CDN网络的源节点(接入节点)。源节点收到音视频流后，再通过Convert服务器将RTMP流切割为HLS切片文件，即.ts文件。同时生成与之对应的m3u8文件，即HLS播放列表文件</p><p>切割后的HLS分片文件(.ts文件)和HLS列表文件(.m3u8文件)经CDN网络转发后，客户端就可以从离自己最近的CDN边缘节点拉取HLS媒体流了。</p><p>在拉取HLS媒体流时，客户端首先通过HLS协议将m3u8索引文件下载下来，然后按索引文件中的顺序，将.ts文件一片片下载下来，然后一边播放一边缓冲。此时，你就可以在PC、手机、平板等设备观看直播节目。</p><p>对于使用HLS协议的直播系统来说，最重要的一步就是切片。源节点服务器收到音视频流后，先要数据缓冲起来，保证到达帧的所有分片都已收到之后，才会将它们切片成ts流。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ffmpeg生成hls切片">FFmpeg生成HLS切片<a class="hash-link" href="#ffmpeg生成hls切片" title="标题的直接链接">​</a></h2><p>通过FFmpeg工具将一个MP4文件转换为HLS切片和索引文件的。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">切片命令</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ffmpeg -i test.mp4 -c copy -start_number </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> -hls_time </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> -hls_list_size </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> -hls_segment_filename test%03d.ts index.m3u8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">该命令参数说明如下:</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">-</span><span class="token plain">i 输入文件选项，可以是磁盘文件，也可以是媒体设备</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c copy 表示只是进行封装格式的转换。不需要将多媒体文件中的音视频数据重新进行编码。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">start_number 表示 </span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ts</span><span class="token plain"> 文件的起始编号，这里设置从 </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> 开始。当然，你也可以设置其他数字。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hls_time 表示每个 </span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ts</span><span class="token plain"> 文件的最大时长，单位是秒。这里设置的是 10s，表示每个切片文件的时长，为 </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> 秒。当然，由于没有进行重新编码，所以这个时长并不准确。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hls_list_size 表示播放列表文件的长度，</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> 表示不对播放列表文件的大小进行限制。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">hls_segment_filename  表示指定 </span><span class="token constant" style="color:#36acaa">TS</span><span class="token plain"> 文件的名称。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">m3u8，表示索引文件名称。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行完毕后，在当前路径下回生成一系列.ts文件和index.m3u8文件。下面，我们在分别分析.m3u8文件格式和.ts文件格式</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="m3u8格式分析">m3u8格式分析<a class="hash-link" href="#m3u8格式分析" title="标题的直接链接">​</a></h2><p>正如前面讲到，HLS必须要有一个.m3u8的索引文件。它是一个播放列表文件，文件的编码必须是UTF-8格式。这里我们将前面生成的.m3u8文件内容展示一下，一边让你有个感观的认识。内容如下</p><div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token constant" style="color:#36acaa">EXTM3U</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token constant" style="color:#36acaa">EXT</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">X</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">VERSION</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">// 版本信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token constant" style="color:#36acaa">EXT</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">X</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">TARGETDURATION</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//每个分片的目标时长</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token constant" style="color:#36acaa">EXT</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">X</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">MEDIA</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">SEQUENCE</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//分片起始编号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token constant" style="color:#36acaa">EXTINF</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">10.922578</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">//分片实际时长</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test000</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ts               </span><span class="token comment" style="color:#999988;font-style:italic">//分片文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token constant" style="color:#36acaa">EXTINF</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9.929578</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//第二个分片实际时长</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test001</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ts               </span><span class="token comment" style="color:#999988;font-style:italic">//第二个分片文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//... </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://datatracker.ietf.org/doc/html/draft-pantos-hls-rfc8216bis-04#section-4" target="_blank" rel="noopener noreferrer">RFC8216</a>规定，.m3u8文件内容以#字母开头的行是注释和TG，其中TAG必须是#EXT开头。</p><ul><li>EXTM3U表示文件是一个扩展的m3u8文件，此TAG必须放在索引文件的第一行。</li><li>EXT-X-VERSION:n 表示索引文件支持的版本号，后面的数字n是版本号数字。需要注意的是，一个索引文件只能有一行版本号TAG，否则播放器会解析报错。</li><li>EXT-X-TARGETDURATION:s 表示.ts切片的最大时长，单位是秒</li><li>EXT-X-MEDIA-SEQUENCE:n 表示第一个.ts切片文件的编号。若不设置此项，就是默认从0开始的。</li><li>EXTINF:duration, title 表示.ts文件的时长和文件名称。文件时长不能超过#EXT-X-TARGETDURATION中设置的最大时长，并且时长的单位应该采用浮点数来提高精度。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ts格式分析">TS格式分析<a class="hash-link" href="#ts格式分析" title="标题的直接链接">​</a></h2><p>HLS协议是由PAT+PMT+TS数据流组成的。其中TS数据中的视频数据采用H264编码，而音频数据采用AAC/MP3编码。ts数据流示意图如下所示</p><p><img loading="lazy" alt="TS数据流示意图" src="/assets/images/ts-ce4ec8aeb7c912fe595573cfd496314a.png" width="1918" height="468" class="img_ev3q"></p><p>TS数据流由TS Header和TS Payload组成。其中TS Header占4字节，TS Payload占184字节，即TS数据流总长度是188字节。</p><p>TS Payload又由PES Header 和PES Payload 组成。其中，PES Payload是真正的音视频流，也称ES流。</p><ul><li>PES（Packet Elementary Stream）是将 ES 流增加 PES Header 后形成的数据包。</li><li>ES（Elementary Stream），基流，是编码后的音视频数据。</li></ul><p><img loading="lazy" alt="TS文件格式图" src="/assets/images/ts-header-125483cde555fc0e31adedf36c04f1a7.png" width="2021" height="1031" class="img_ev3q"></p><p>上图展示了TS Header各个字段的详细说明，图中数字表示长度，如果数字后面带有bytes，单位就是bytes；否则，单位都是bit。</p><table><thead><tr><th align="left">字段名称</th><th align="center">单位(bit)</th><th align="left">字段说明</th></tr></thead><tbody><tr><td align="left">sync_byte</td><td align="center">8</td><td align="left">固定值是0x47，算是magic字段，用它可以判断是否为TS文件</td></tr><tr><td align="left">transport_error_indicator</td><td align="center">1</td><td align="left">传输错误指示标志，如果此标志为1，表示发生了不可纠正的错误</td></tr><tr><td align="left">payload_unit_start_indicator</td><td align="center">1</td><td align="left">标识TS数据流的Payload域中包含的是否为PES数据。  <br>  为1：表示TS Header后面第一个字节是PES Header的内容。   <br>   为0：表示后面直接是ES数据</td></tr><tr><td align="left">transport_priority</td><td align="center">1</td><td align="left">包优先级标志，设置为1表示高优先级</td></tr><tr><td align="left">PID</td><td align="center">13</td><td align="left">Packet Identifier 是每个ES的唯一标识。PID的部分值是保留的，用来区分Payload的类型</td></tr><tr><td align="left">transport_scrambling_control</td><td align="center">2</td><td align="left">扰码控制模式，有四种模式：00 表示不加扰码；01/10/11由用户自定义</td></tr><tr><td align="left">adaptation_field_control</td><td align="center">2</td><td align="left">表示在TS Header后面是否有适配控制字段</td></tr><tr><td align="left">continuity_counter</td><td align="center">4</td><td align="left">TS数据包累加计算器、对于同一个PID的TS流，此字段每次都会增加，最大值是15，溢出后，从0开始计数。 <br>   此值受adaptation_field_control字段控制，当取值00或10时，计数不累加。这也说明累加器只对包含Payload的TS数据包起作用</td></tr></tbody></table><p>PES Packet 作为TS数据流的Payload，也有自己的Header，如下图所示</p><p><img loading="lazy" alt="PES结构图" src="/assets/images/ts-pes-40004e73d9ef7ec72cc495ac2dffd266.png" width="1606" height="966" class="img_ev3q"></p><p>PES Header长度是6字节，字段说明如下：（可参考ISO-IES 13818-1 2.4.3.7节）</p><table><thead><tr><th align="left">字段名称</th><th align="center">单位(bit)</th><th align="left">字段说明</th></tr></thead><tbody><tr><td align="left">packet_start_code_prefix</td><td align="center">24</td><td align="left">PES包前缀，固定值是0x000001</td></tr><tr><td align="left">stream_id</td><td align="center">8</td><td align="left">节目流ID，用于标识ES流。<br> 音频取值(0xc0-0xdf)，通常为0xc0 <br> 视频取值(0xe0-0xef)，通常为0x0</td></tr><tr><td align="left">PES_packet_length</td><td align="center">16</td><td align="left">表示PES包长度，从PES_packet_length 字段后的第一个字节开始计算。如果此值为0，表示长度不受限制</td></tr><tr><td align="left">PES_scrambling_control</td><td align="center">2</td><td align="left">PES包扰码模式</td></tr><tr><td align="left">PES_priority</td><td align="center">1</td><td align="left">PES包优先级，取值1优先级更高</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ts加密解密">TS加密&amp;解密<a class="hash-link" href="#ts加密解密" title="标题的直接链接">​</a></h2><p>HLS协议采用M3U8文件来告知客户端视频文件播放列表，客户端拿到M3U8文件以后就可以直接播放视频，为了避免源站的视频文件被非授权客户端访问，需要对HLS协议使用的TS视频文件做加密，对TS视频文件做了加密以后，还需要告知客户端解密方法，这里就可以通过配置M3U8标准加密改写功能，通过#EXT-X-KEY标签来告知客户端加密算法、密钥URI和鉴权key。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#EXT-X-KEY 是否加密解析。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>例如：#EXT-X-KEY:METHOD=AES-128,URI=&quot;<a href="https://example.com/video.key?token=xxx%22" target="_blank" rel="noopener noreferrer">https://example.com/video.key?token=xxx&quot;</a> 加密算法是AES-128，密钥通过请求 <a href="https://example.com/video.key?token=xxx" target="_blank" rel="noopener noreferrer">https://example.com/video.key?token=xxx</a> 来获取，密钥请求回来以后存储在本地，并用于解密后续下载的TS视频文件。</p><p>前端处理加密请求。如果服务端设置请求key只允许一次。那么需要设置第一次缓存的key缓存到本地
<a href="https://github.com/videojs/http-streaming#cacheencryptionkeys" target="_blank" rel="noopener noreferrer">https://github.com/videojs/http-streaming#cacheencryptionkeys</a></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a class="hash-link" href="#参考资料" title="标题的直接链接">​</a></h4><p><a href="https://time.geekbang.org/column/article/141052" target="_blank" rel="noopener noreferrer">HLS：实现一对多直播系统的必备协议</a><br>
<a href="https://www.jianshu.com/p/2ce402a485ca" target="_blank" rel="noopener noreferrer">HTTP Live Streaming (HLS) - 概念</a><br>
<a href="https://help.aliyun.com/document_detail/179287.htm" target="_blank" rel="noopener noreferrer">配置M3U8标准加密改写</a><br>
<a href="https://www.it610.com/article/1295242903345504256.htm" target="_blank" rel="noopener noreferrer">视频TS文件AES加密处理</a></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/media"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">基本介绍</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/media/FLV"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">FLV</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#hls直播架构" class="table-of-contents__link toc-highlight">HLS直播架构</a></li><li><a href="#ffmpeg生成hls切片" class="table-of-contents__link toc-highlight">FFmpeg生成HLS切片</a></li><li><a href="#m3u8格式分析" class="table-of-contents__link toc-highlight">m3u8格式分析</a></li><li><a href="#ts格式分析" class="table-of-contents__link toc-highlight">TS格式分析</a></li><li><a href="#ts加密解密" class="table-of-contents__link toc-highlight">TS加密&amp;解密</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/iiLsss/iiLsss.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 地球, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8769d743.js"></script>
<script src="/assets/js/main.44404fa1.js"></script>
</body>
</html>