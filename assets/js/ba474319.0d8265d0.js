"use strict";(self.webpackChunkdiqiu_website=self.webpackChunkdiqiu_website||[]).push([[5198],{3905:(e,n,r)=>{r.d(n,{Zo:()=>p,kt:()=>k});var t=r(7294);function o(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function i(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function l(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?i(Object(r),!0).forEach((function(n){o(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function a(e,n){if(null==e)return{};var r,t,o=function(e,n){if(null==e)return{};var r,t,o={},i=Object.keys(e);for(t=0;t<i.length;t++)r=i[t],n.indexOf(r)>=0||(o[r]=e[r]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)r=i[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var s=t.createContext({}),c=function(e){var n=t.useContext(s),r=n;return e&&(r="function"==typeof e?e(n):l(l({},n),e)),r},p=function(e){var n=c(e.components);return t.createElement(s.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},u=t.forwardRef((function(e,n){var r=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,p=a(e,["components","mdxType","originalType","parentName"]),u=c(r),k=o,g=u["".concat(s,".").concat(k)]||u[k]||d[k]||i;return r?t.createElement(g,l(l({ref:n},p),{},{components:r})):t.createElement(g,l({ref:n},p))}));function k(e,n){var r=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=r.length,l=new Array(i);l[0]=u;var a={};for(var s in n)hasOwnProperty.call(n,s)&&(a[s]=n[s]);a.originalType=e,a.mdxType="string"==typeof e?e:o,l[1]=a;for(var c=2;c<i;c++)l[c]=r[c];return t.createElement.apply(null,l)}return t.createElement.apply(null,r)}u.displayName="MDXCreateElement"},4566:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var t=r(7462),o=(r(7294),r(3905));const i={},l="Fiber&Render",a={unversionedId:"react/fiber&render",id:"react/fiber&render",title:"Fiber&Render",description:"\u524d\u7f6e\u77e5\u8bc6\uff1aJSX",source:"@site/docs/react/3.fiber&render.md",sourceDirName:"react",slug:"/react/fiber&render",permalink:"/docs/react/fiber&render",draft:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{},sidebar:"react",previous:{title:"Virtual-DOM",permalink:"/docs/react/virtualDOM"},next:{title:"DOM-DIFF",permalink:"/docs/react/dom-diff"}},s={},c=[{value:"Fiber \u57fa\u672c\u4ecb\u7ecd",id:"fiber-\u57fa\u672c\u4ecb\u7ecd",level:2},{value:"Fiber \u7ed3\u6784",id:"fiber-\u7ed3\u6784",level:2},{value:"Fiber \u8282\u70b9\u7684\u6570\u636e\u7ed3\u6784",id:"fiber-\u8282\u70b9\u7684\u6570\u636e\u7ed3\u6784",level:3},{value:"Fiber \u6811\u7684\u7ed3\u6784",id:"fiber-\u6811\u7684\u7ed3\u6784",level:3},{value:"Render \u6e32\u67d3\u9636\u6bb5\u2014\u2014\u521d\u6b21\u6e32\u67d3",id:"render-\u6e32\u67d3\u9636\u6bb5\u521d\u6b21\u6e32\u67d3",level:2},{value:"1. \u521b\u5efa hostFiberRoot",id:"1-\u521b\u5efa-hostfiberroot",level:3},{value:"2. \u521b\u5efa workInProgress",id:"2-\u521b\u5efa-workinprogress",level:3},{value:"\u5c0f\u7ed3",id:"\u5c0f\u7ed3",level:3},{value:"\u5de5\u4f5c\u6d41\u7a0b",id:"\u5de5\u4f5c\u6d41\u7a0b",level:4},{value:"Render \u6e32\u67d3\u9636\u6bb5\u2014\u2014\u66f4\u65b0\u6e32\u67d3",id:"render-\u6e32\u67d3\u9636\u6bb5\u66f4\u65b0\u6e32\u67d3",level:2},{value:"1. \u53cc\u7f13\u5b58\u7ed3\u6784",id:"1-\u53cc\u7f13\u5b58\u7ed3\u6784",level:3},{value:"2. \u66f4\u65b0 workInProgress",id:"2-\u66f4\u65b0-workinprogress",level:3},{value:"\u5c0f\u7ed3",id:"\u5c0f\u7ed3-1",level:3}],p={toc:c};function d(e){let{components:n,...i}=e;return(0,o.kt)("wrapper",(0,t.Z)({},p,i,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"fiberrender"},"Fiber&Render"),(0,o.kt)("p",null,"\u524d\u7f6e\u77e5\u8bc6\uff1a",(0,o.kt)("a",{parentName:"p",href:"/docs/react/jsx"},"JSX")),(0,o.kt)("h2",{id:"fiber-\u57fa\u672c\u4ecb\u7ecd"},"Fiber \u57fa\u672c\u4ecb\u7ecd"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Fiber \u4ea7\u751f\u7684\u539f\u56e0\uff1f")),(0,o.kt)("p",null,"\u6ca1\u6709 Fiber \u6709\u4ec0\u4e48\u95ee\u9898\uff1f\nReact \u4f1a\u9012\u5f52\u6bd4\u5bf9\u865a\u62df DOM \u6811\uff0c\u627e\u51fa\u9700\u8981\u53d8\u52a8\u7684\u8282\u70b9\uff0c\u7136\u540e\u540c\u6b65\u66f4\u65b0\u5b83\u4eec\u3002\u5728\u6b64\u671f\u95f4 React \u4f1a\u5360\u7528\u6d4f\u89c8\u5668\u8d44\u6e90\uff0c\u5bfc\u81f4\u5361\u987f\u3002\n\u5f15\u5165 Fiber \u5b9e\u73b0\u4e86\u4ec0\u4e48\u529f\u80fd\uff1f"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Fiber \u662f\u4ec0\u4e48\uff1f")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u6267\u884c\u5355\u5143\uff1a\u6bcf\u4e2a Fiber \u662f\u4e00\u4e2a\u5de5\u4f5c\u6267\u884c\u5355\u5143\u3002"),(0,o.kt)("li",{parentName:"ul"},"\u6570\u636e\u7ed3\u6784\uff1a\u5355\u94fe\u8868\u7ed3\u6784\uff0c\u6839\u636e React \u865a\u62df DOM \u6811\u751f\u6210\uff0c\u6bcf\u4e2a\u8282\u70b9\u90fd\u4f1a\u751f\u6210\u4e00\u4e2a Fiber")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u865a\u62df DOM \u5b50\u8282\u70b9\u662f\u6587\u672c\u8282\u70b9\u7684\u8bdd\uff0c\u4e0d\u4f1a\u521b\u5efa Fiber")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Fiber \u6267\u884c\u9636\u6bb5")),(0,o.kt)("p",null,"\u6bcf\u6b21\u6e32\u67d3\u6709\u4e24\u4e2a\u9636\u6bb5\uff1a\u534f\u8c03\u9636\u6bb5\uff08Reconciliation\uff09 \u548c \u63d0\u4ea4\u9636\u6bb5\uff08commit\uff09"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u534f\u8c03\u9636\u6bb5\uff1a\u6784\u5efa Fiber \u6811\uff0c\u627e\u51fa\u53d8\u52a8\u7684\u8282\u70b9\uff0c\u7ec4\u6210\u526f\u4f5c\u7528\u94fe Effect List"),(0,o.kt)("li",{parentName:"ul"},"\u63d0\u4ea4\u9636\u6bb5\uff1a\u904d\u5386\u526f\u4f5c\u7528\u94fe Effect List \u66f4\u65b0\u5230 DOM \u4e0a")),(0,o.kt)("h2",{id:"fiber-\u7ed3\u6784"},"Fiber \u7ed3\u6784"),(0,o.kt)("h3",{id:"fiber-\u8282\u70b9\u7684\u6570\u636e\u7ed3\u6784"},"Fiber \u8282\u70b9\u7684\u6570\u636e\u7ed3\u6784"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// react-reconciler/src/ReactFiber.old.js\n/**\n * fiber\u6784\u5efa\u51fd\u6570\n * @param {*} tag fiber\u7c7b\u578b\n * @param {*} pendingProps  \u65b0\u5c5e\u6027\u5bf9\u8c61\n * @param {*} key \u552f\u4e00\u6807\u8bc6\n */\nfunction FiberNode(\n  tag: WorkTag,\n  pendingProps: mixed,\n  key: null | string,\n  mode: TypeOfMode\n) {\n  // Instance\n  this.tag = tag; // fiber\u7c7b\u578b\uff08HostRoot / HostComponent \uff09\n  this.key = key; // \u552f\u4e00\u6807\u8bc6\u7b26\n  this.elementType = null;\n  this.type = null; //\n  this.stateNode = null; // \u771f\u5b9edom\u8282\u70b9\n\n  // Fiber \u6811\u7ed3\u6784\u7528\u4e8e\u8fde\u63a5\u7236\u8282\u70b9\u3001\u5b50\u8282\u70b9\u3001\u5144\u5f1f\u8282\u70b9\n  this.return = null; // \u7236\u8282\u70b9\n  this.child = null; // \u5b50\u8282\u70b9\n  this.sibling = null; // \u5144\u5f1f\u8282\u70b9\n  this.index = 0;\n\n  this.ref = null;\n  // \u5c5e\u6027\n  this.pendingProps = pendingProps;\n  this.memoizedProps = null;\n  this.updateQueue = null;\n  this.memoizedState = null;\n  this.dependencies = null;\n\n  this.mode = mode;\n\n  // Effects \u526f\u4f5c\u7528\u94fe\n  this.flags = NoFlags; // \u662f\u5426\u6709\u526f\u4f5c\u7528\n  this.nextEffect = null; // \u8fde\u63a5\u4e0b\u4e00\u4e2a\u526f\u4f5c\u7528\u8282\u70b9\n  this.firstEffect = null; //\n  this.lastEffect = null;\n\n  this.lanes = NoLanes;\n  this.childLanes = NoLanes;\n  // \u5f53\u524dDOM\u7684Fiber\u4e0e\u8981\u66f4\u65b0Fiber\u4e4b\u95f4\u7684\u8fde\u63a5\n  this.alternate = null;\n}\n")),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(997).Z,width:"668",height:"589"})),(0,o.kt)("h3",{id:"fiber-\u6811\u7684\u7ed3\u6784"},"Fiber \u6811\u7684\u7ed3\u6784"),(0,o.kt)("p",null,"\u6839\u636e\u865a\u62df DOM \u751f\u6210 Fiber \u6811"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"let element = (\n  <div id='A1' style={style}>\n    A\n    <div id='B1' style={style}>\n      B1\n    </div>\n    <div id='B2' style={style}>\n      B2\n    </div>\n  </div>\n);\n")),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(2106).Z,width:"1248",height:"808"})),(0,o.kt)("h2",{id:"render-\u6e32\u67d3\u9636\u6bb5\u521d\u6b21\u6e32\u67d3"},"Render \u6e32\u67d3\u9636\u6bb5\u2014\u2014\u521d\u6b21\u6e32\u67d3"),(0,o.kt)("h3",{id:"1-\u521b\u5efa-hostfiberroot"},"1. \u521b\u5efa hostFiberRoot"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// 1. legacyCreateRootFromDOMContainer\n// 2. createLegacyRoot\n// 3. ReactDOMBlockingRoot\n// 4. createRootImpl\n// 5. createContainer\n// 6. createFiberRoot\nexport function createFiberRoot(\n  containerInfo: any,\n  tag: RootTag,\n  hydrate: boolean,\n  hydrationCallbacks: null | SuspenseHydrationCallbacks\n): FiberRoot {\n  // \u521b\u5efa DOM\n  const root: FiberRoot = (new FiberRootNode(containerInfo, tag, hydrate): any);\n  // \u521b\u5efaFiber\u6811\u7684\u6839\u8282\u70b9\n  const uninitializedFiber = createHostRootFiber(tag);\n  root.current = uninitializedFiber;\n  // \u6839Fiber\u7684\u771f\u5b9eDOM\u8282\u70b9\u6307\u5411fiberRoot;\n  uninitializedFiber.stateNode = root;\n  initializeUpdateQueue(uninitializedFiber);\n  return root;\n}\n// 7. updateContainer(children, fiberRoot, parentComponent, callback);\nexport function updateContainer(\n  element: ReactNodeList,\n  container: OpaqueRoot,\n  parentComponent: ?React$Component<any, any>,\n  callback: ?Function\n): Lane {\n  enqueueUpdate(current, update); // \u6302\u8f7d\u66f4\u65b0\u961f\u5217 enqueueUpdate\n  scheduleUpdateOnFiber(current, lane, eventTime);\n}\n")),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(3347).Z,width:"811",height:"612"})),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u53ef\u4ee5\u7406\u89e3\u4e3a\u521b\u5efa\u6839 Fiber \u540e\u3002\u8868\u793a\u4e86\u5f53\u524d\u9875\u9762\u7684\u5b58\u5728 div#root \u7684 DOM\uff0c\u63a5\u7740\u8c03\u7528 updateContainer \u53bb\u5bf9\u6bd4\u751f\u6210\u5373\u5c06\u6e32\u67d3\u7684 DOM")),(0,o.kt)("h3",{id:"2-\u521b\u5efa-workinprogress"},"2. \u521b\u5efa workInProgress"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// 8. scheduleUpdateOnFiber\n// 9. performSyncWorkOnRoot\n//10. renderRootSync  prepareFreshStack createWorkInProgress workInProgress\nexport function createWorkInProgress(current: Fiber, pendingProps: any): Fiber {\n  // \u9996\u6b21\u8fdb\u53bb\u4e0d\u5b58\u5728\n  let workInProgress = current.alternate;\n  if (workInProgress === null) {\n    // \u521b\u5efa workInProgress\n    workInProgress = createFiber(\n      current.tag,\n      pendingProps,\n      current.key,\n      current.mode\n    );\n    workInProgress.elementType = current.elementType;\n    workInProgress.type = current.type;\n    workInProgress.stateNode = current.stateNode;\n\n    workInProgress.alternate = current;\n    current.alternate = workInProgress;\n  } else {\n    workInProgress.pendingProps = pendingProps;\n    workInProgress.type = current.type;\n    workInProgress.flags = NoFlags;\n\n    workInProgress.nextEffect = null;\n    workInProgress.firstEffect = null;\n    workInProgress.lastEffect = null;\n  }\n\n  workInProgress.childLanes = current.childLanes;\n  workInProgress.lanes = current.lanes;\n\n  workInProgress.child = current.child;\n  workInProgress.memoizedProps = current.memoizedProps;\n  workInProgress.memoizedState = current.memoizedState;\n  workInProgress.updateQueue = current.updateQueue;\n\n  workInProgress.sibling = current.sibling;\n  workInProgress.index = current.index;\n  workInProgress.ref = current.ref;\n\n  return workInProgress;\n}\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"workInProgress",src:r(1010).Z,width:"933",height:"601"})),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u9996\u6b21\u6e32\u67d3\u4e0d\u5b58\u5728 workInProgress\uff0c\u5219\u6839\u636e\u6839\u8282\u70b9\u7684 Fiber.tag = 3 \u53bb\u521b\u5efa workInProgress")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'//11. workLoopSync\n//12. performUnitOfWork\n//13.beginWork$1 beginWork\n//14 updateHostRoot \u6b64\u65f6tag = 3\nfunction updateHostRoot(current, workInProgress, renderLanes) {\n  const nextProps = workInProgress.pendingProps;\n  const prevState = workInProgress.memoizedState;\n  const prevChildren = prevState !== null ? prevState.element : null;\n  cloneUpdateQueue(current, workInProgress);\n  processUpdateQueue(workInProgress, nextProps, null, renderLanes);\n  const nextState = workInProgress.memoizedState;\n  // Caution: React DevTools currently depends on this property\n  // being called "element".\n  const nextChildren = nextState.element;\n}\n// 15 reconcileChildren\n\nfunction reconcileChildren(current, workInProgress, nextChildren, renderLanes) {\n  if (current === null) {\n    workInProgress.child = mountChildFibers(\n      workInProgress,\n      null,\n      nextChildren,\n      renderLanes\n    );\n  } else {\n    workInProgress.child = reconcileChildFibers(\n      workInProgress,\n      current.child,\n      nextChildren,\n      renderLanes\n    );\n  }\n}\n// 16 reconcileChildFibers\n// 17 reconcileSingleElement\n// 18 createFiberFromElement\n')),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(4737).Z,width:"970",height:"658"})),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u5728 beginwork \u4e2d\u8fdb\u884c\u5e76\u5bf9 workInProgress \u6302\u8f7d child \u8fd4\u56de performUnitOfWork \u4e2d\u7684 next \u53d8\u91cf\u3002next \u5b58\u5728\u5219\u7ee7\u7eed\u5faa\u73af\u4e0a\u8ff0\u6b65\u9aa4")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// next\u8fd4\u56deA1\n// beginWork$1 beginWork\n// updateHostComponent \u6b64\u65f6tag = 5\n// reconcileChildren => mountChildFibers\n// reconcileChildrenArray\n// createChild \u521b\u5efa\u65b0\u7684fiber\u8282\u70b9\n\nif (oldFiber === null) {\n  // If we don't have any more existing children we can choose a fast path\n  // since the rest will all be insertions.\n  for (; newIdx < newChildren.length; newIdx++) {\n    var _newFiber = createChild(returnFiber, newChildren[newIdx], lanes);\n\n    if (_newFiber === null) {\n      continue;\n    }\n\n    lastPlacedIndex = placeChild(_newFiber, lastPlacedIndex, newIdx);\n\n    if (previousNewFiber === null) {\n      // TODO: Move out of the loop. This only happens for the first run.\n      resultingFirstChild = _newFiber;\n    } else {\n      previousNewFiber.sibling = _newFiber;\n    }\n\n    previousNewFiber = _newFiber;\n  }\n\n  return resultingFirstChild;\n}\n\n// performUnitOfWork(workInProgress);\n")),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(7142).Z,width:"1839",height:"884"})),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u751f\u6210 A-Fiber \u540e\uff0c\u5bf9\u5176 children \u5c5e\u6027\u8fdb\u884c\u5224\u65ad\u3002\u5b58\u5728\u591a\u4e2a\uff0c\u5faa\u73af\u521b\u5efa child \u5e76\u4ee5\u6b64 sibling \u8fdb\u884c\u8fde\u63a5")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// next\u8fd4\u56de\u7ee7\u7eedA\n// beginwork\n// updateHostText -> tryToClaimNextHydratableInstance\n// next = null\n// \u6267\u884ccompleteUnitOfWork(unitOfWork)\n// completeWork\n// createTextInstance stateNode\n")),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(5827).Z,width:"1798",height:"1059"})),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"\u6267\u884c completeWork \u5bf9 A \u6587\u672c\u751f\u6210 text \u5b9e\u9645 DOM\uff0c\u5bf9\u5176\u5224\u65ad\u662f\u5426\u5b58\u5728\u5144\u5f1f\u8282\u70b9\uff0c\u5219 workInProgress \u8d4b\u503c\u4e3a\u5144\u5f1f B1")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// performUnitOfWork  beginWork$1\u4e0d\u5b58\u5728\u5b57\u8282\u70b9\n// completeUnitOfWork\n// completeWork\n// createInstance\nfunction createInstance(\n  type,\n  props,\n  rootContainerInstance,\n  hostContext,\n  internalInstanceHandle\n) {\n  var parentNamespace;\n\n  {\n    // TODO: take namespace into account when validating.\n    var hostContextDev = hostContext;\n    validateDOMNesting(type, null, hostContextDev.ancestorInfo);\n\n    if (\n      typeof props.children === 'string' ||\n      typeof props.children === 'number'\n    ) {\n      var string = '' + props.children;\n      var ownAncestorInfo = updatedAncestorInfo(\n        hostContextDev.ancestorInfo,\n        type\n      );\n      validateDOMNesting(null, string, ownAncestorInfo);\n    }\n\n    parentNamespace = hostContextDev.namespace;\n  }\n\n  var domElement = createElement(\n    type,\n    props,\n    rootContainerInstance,\n    parentNamespace\n  );\n  precacheFiberNode(internalInstanceHandle, domElement);\n  updateFiberProps(domElement, props);\n  return domElement;\n}\n")),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(6178).Z,width:"1812",height:"1017"})),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"\u91cd\u590d\u4e0a\u8ff0\u6b65\u9aa4\u4e00\u6b21\u628a B1 \u548c B2 \u7684\u771f\u5b9e DOM \u6302\u8f7d\u5230 stateNode\n\u5b8c\u6210\u6240\u6709\u5144\u5f1f\u8282\u70b9\u540e\uff0c\u53d6\u5176\u7236\u5b50\u5c40\u7ee7\u7eed\u6267\u884c\u8be5\u65b9\u6cd5\u751f\u6210 A \u7684\u771f\u5b9e DOM \u6302\u8f7d\u5230 stateNode\n\u6267\u884c appendAllChildren \u4f1a\u5c06\u6587\u672c A\u3001DivB1\u3001DivB2 \u6dfb\u52a0\u53bb DivA \u4e2d")),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(9824).Z,width:"1844",height:"1049"})),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u9488\u5bf9 A \u751f\u6210\u526f\u4f5c\u7528\u94fe\u8868 effectList")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"\u6b64\u65f6\u521d\u6b21\u6e32\u67d3\u9636\u6bb5\u5df2\u7ecf\u5b8c\u6210\uff0c\u5373\u5c06\u8fdb\u5165\u63d0\u4ea4\u9636\u6bb5",(0,o.kt)("inlineCode",{parentName:"strong"},"commitRoot"),"\uff0c\u6b32\u77e5\u540e\u4e8b\u5982\u4f55\uff0c\u8bf7\u542c\u4e0b\u56de\u5206\u89e3\u3002")),(0,o.kt)("h3",{id:"\u5c0f\u7ed3"},"\u5c0f\u7ed3"),(0,o.kt)("h4",{id:"\u5de5\u4f5c\u6d41\u7a0b"},"\u5de5\u4f5c\u6d41\u7a0b"),(0,o.kt)("p",null,"\u6839\u636e\u521d\u6b21\u6e32\u67d3\u6d41\u7a0b\uff0c\u5728 Render \u9636\u6bb5\u7684\u4e3b\u8981\u5de5\u4f5c\u6d41\u7a0b"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"createFiberRoot \u521b\u5efa Fiber \u6839\u8282\u70b9",(0,o.kt)("inlineCode",{parentName:"li"},"HostRootFiber"),"\u4e0e\u6839\u636e\u5165\u53c2",(0,o.kt)("inlineCode",{parentName:"li"},"div#root"),"\u521b\u5efa",(0,o.kt)("inlineCode",{parentName:"li"},"FiberRootNode")),(0,o.kt)("li",{parentName:"ul"},"createWorkInProgress \u6839\u636e\u865a\u62df DOM \u6811\u751f\u6210 ",(0,o.kt)("inlineCode",{parentName:"li"},"workInProgressFiber")," \u6811"),(0,o.kt)("li",{parentName:"ul"},"performUnitOfWork \u6267\u884c\u5355\u4e2a\u5de5\u4f5c\u5355\u5143"),(0,o.kt)("li",{parentName:"ul"},"beginWork \u6784\u5efa\u5f53\u524d Fiber \u7684\u5b50 Fiber \u94fe\u8868"),(0,o.kt)("li",{parentName:"ul"},"completeUnitOfWork \u5982\u679c\u5f53\u524d Fiber \u6ca1\u6709",(0,o.kt)("inlineCode",{parentName:"li"},"childFiber"),"\u5b50\u8282\u70b9\uff0c\u5219\u5b8c\u6210\u5f53\u524d\u5de5\u4f5c\u5355\u5143\u6267\u884c\uff0c\u5e76\u79fb\u52a8\u5230\u6b64 Fiber \u7684",(0,o.kt)("inlineCode",{parentName:"li"},"siblingFiber"),"\u5f1f\u5f1f\u8282\u70b9\u7ee7\u7eed\u6267\u884c\uff0c\u5982\u679c\u4e0d\u5b58\u5728",(0,o.kt)("inlineCode",{parentName:"li"},"sibling"),"\u5219\uff0c\u8fd4\u56de",(0,o.kt)("inlineCode",{parentName:"li"},"returnFiber"),"\u7236\u8282\u70b9"),(0,o.kt)("li",{parentName:"ul"},"completeWork \u751f\u6210\u5f53\u524d Fiber \u7684\u771f\u662f DOM \u5e76\u6302\u8f7d\u5230",(0,o.kt)("inlineCode",{parentName:"li"},"stateNode"),"\u5b57\u6bb5\u3002\u5e76\u6302\u8f7d",(0,o.kt)("inlineCode",{parentName:"li"},"effectList"),"\u526f\u4f5c\u7528\u94fe\u8868")),(0,o.kt)("p",null,"\u751f\u6210 Fiber \u6811\u7684\u89c4\u5219"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"1. \u6839\u636e\u865a\u62dfDOM\u6df1\u5ea6\u4f18\u5148\u904d\u5386\n2. \u4ece\u9876\u70b9\u5f00\u59cb\u904d\u5386\n3. \u751f\u6210\u5b50\u8282\u70b9Fiber\u6811\uff08\u5b58\u5728\u591a\u4e2a\u7528sibling\u8fde\u63a5\uff09\n4. \u5148\u5b50\u8282\u70b9 -> \u5f1f\u5f1f\u8282\u70b9 -> \u7236\u8282\u70b9\u7684\u5f1f\u5f1f\u8282\u70b9\n5. \u81ea\u5df1\u6ca1\u6709\u5b50\u8282\u70b9\u6216\u8005\u81ea\u5df1\u7684\u6240\u6709\u5b50\u8282\u70b9\u904d\u5386\u5b8c\u6210\uff0c\u5219\u5b8c\u6210\u5f53\u524d\u8282\u70b9\u7684\u904d\u5386\n")),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(9367).Z,width:"1093",height:"882"})),(0,o.kt)("h2",{id:"render-\u6e32\u67d3\u9636\u6bb5\u66f4\u65b0\u6e32\u67d3"},"Render \u6e32\u67d3\u9636\u6bb5\u2014\u2014\u66f4\u65b0\u6e32\u67d3"),(0,o.kt)("p",null,"\u66f4\u65b0\u9636\u6bb5\u6839\u636e currentFiber \u548c\u865a\u62df DOM \u7684\u6bd4\u5bf9\uff08 DOM-DIFF\uff09\u751f\u6210\u65b0\u7684 workInProgressFiber"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"let element = (\n  <div id='A1' style={style}>\n    TEXT_A\n    <div id='B1' style={style}>\n      TEXT_B1\n    </div>\n    <div id='B2-new' style={style}>\n      <p id='C'>CCC</p>\n    </div>\n    <div id='B3' style={style}>\n      TEXT_B3\n    </div>\n  </div>\n);\n")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u6b64\u65f6\u6211\u4eec\u66f4\u65b0 DOM \u4e3a\u4e0a\u8ff0\u5185\u5bb9")),(0,o.kt)("h3",{id:"1-\u53cc\u7f13\u5b58\u7ed3\u6784"},"1. \u53cc\u7f13\u5b58\u7ed3\u6784"),(0,o.kt)("p",null,"\u53cc\u7f13\u5b58\u7ed3\u6784\uff1a\u6bcf\u6b21\u66f4\u65b0\u590d\u7528\u4e0a\u6b21",(0,o.kt)("inlineCode",{parentName:"p"},"hostFiberRoot.alternate"),"\u4e3a workInProgress\u3002"),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(7401).Z,width:"1400",height:"1110"})),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// updateContainer\n// scheduleUpdateOnFiber\n// performSyncWorkOnRoot workLoopSync  performUnitOfWork (currentFiber)\n// updateHostRoot(current, workInProgress, renderLanes);\nfunction useFiber(fiber: Fiber, pendingProps: mixed): Fiber {\n  const clone = createWorkInProgress(fiber, pendingProps);\n  clone.index = 0;\n  clone.sibling = null;\n  return clone;\n}\n// This is used to create an alternate fiber to do work on.\nexport function createWorkInProgress(current: Fiber, pendingProps: any): Fiber {\n  let workInProgress = current.alternate;\n  if (workInProgress === null) {\n    workInProgress = createFiber(\n      current.tag,\n      pendingProps,\n      current.key,\n      current.mode\n    );\n    workInProgress.alternate = current;\n    current.alternate = workInProgress;\n  } else {\n    //.../\n  }\n\n  return workInProgress;\n}\n")),(0,o.kt)("h3",{id:"2-\u66f4\u65b0-workinprogress"},"2. \u66f4\u65b0 workInProgress"),(0,o.kt)("p",null,"\u6839\u636e currentFiber \u865a\u62df DOM \u5bf9\u6bd4\u751f\u6210\u65b0\u7684 workInProgressFiber"),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(6101).Z,width:"1608",height:"1102"})),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u8282\u70b9 A \u548c \u8282\u70b9 A \u6587\u672c\u90fd\u53ef\u590d\u7528\uff0c\u5224\u65ad\u662f\u5426\u5b58\u5728 alternate\uff0c\u4e0d\u5b58\u5728\u5219\u65b0\u5efa Fiber \u5e76\u7528 alternate \u8fde\u63a5\u3002")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u8282\u70b9 A \u6587\u672c\u7684 completeWork \u9636\u6bb5\u5b8c\u6210\uff0c\u8282\u70b9 A \u4e0a\u6302\u8f7d effectList")),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(6).Z,width:"1887",height:"1234"})),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u8282\u70b9 B1 \u548c\u8282\u70b9 B2 \u53ef\u590d\u7528\uff0c\u5224\u65ad\u662f\u5426\u5b58\u5728 alternate\uff0c\u4e0d\u5b58\u5728\u5219\u65b0\u5efa Fiber \u5e76\u7528 alternate \u8fde\u63a5\u3002")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u8282\u70b9 B1 completeWork \u9636\u6bb5\u5b8c\u6210\uff0c\u5728\u8282\u70b9 A \u4e0a\u6302\u8f7d effectList")),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(8340).Z,width:"2250",height:"1333"})),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"currentFiber \u4e0d\u5b58\u5728 C\uff0c\u5219\u65b0\u5efa\u8282\u70b9 C\uff0c\u8282\u70b9 C \u6709\u4e00\u4e2a Children \u5e76\u4e14\u662f\u6587\u672c\uff0c\u5219\u4e0d\u53bb\u521b\u5efa Fiber\u3002")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function shouldSetTextContent(type: string, props: Props): boolean {\n  if (type === 'errorInBeginPhase') {\n    throw new Error('Error in host config.');\n  }\n  return (\n    typeof props.children === 'string' || typeof props.children === 'number'\n  );\n}\n")),(0,o.kt)("p",null,(0,o.kt)("img",{src:r(5292).Z,width:"536",height:"317"})),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u8282\u70b9 C \u7684 completeWork \u9636\u6bb5\u5b8c\u6210\uff0c\u5728\u8282\u70b9 B2 \u4e0a\u6302\u8f7d effectList")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u8282\u70b9 B2 \u7684 completeWork \u9636\u6bb5\u5b8c\u6210\uff0c\u5728\u8282\u70b9 A \u4e0a\u6302\u8f7d effectList")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u8282\u70b9 B3 \u7684 completeWork \u9636\u6bb5\u5b8c\u6210\uff0c\u5728\u8282\u70b9 A \u4e0a\u6302\u8f7d effectList")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u8282\u70b9 A \u7684 completeWork \u9636\u6bb5\u5b8c\u6210\uff0c\u5728\u8282\u70b9 HostRoot \u4e0a\u6302\u8f7d effectList")),(0,o.kt)("h3",{id:"\u5c0f\u7ed3-1"},"\u5c0f\u7ed3"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"1. \u53cc\u7f13\u5b58\u7ed3\u6784\u4f9d\u9760alternate\u8fde\u63a5\n2. workInProgress\u751f\u6210\u7684\u8fc7\u7a0b\u5c31\u662fDOM-DIFF\n3. \u8282\u70b9\u53ea\u6709\u4e00\u4e2a\u5b50\u8282\u70b9\uff0c\u800c\u4e14\u8fd9\u4e00\u4e2a\u5b50\u8282\u70b9\u662f\u6587\u672c\u8282\u70b9\u7684\u8bdd\uff0c\u4e0d\u4f1a\u521b\u5efafiber\n")))}d.isMDXComponent=!0},9367:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/beginwork-compelete-flow-c1d6c58fdfc6067c6f0842e6e95c9833.png"},5827:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/compeleWork-A-text-e7a13e1b3a96cdfedf937498743b7b5b.png"},6178:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/compeleWork-B1-B2-A-ac5353427d9c80ec50271d6c12003127.png"},5292:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/compeleWork-C-p-51a3dd0b1d945420a4b8ed45a8384c58.png"},1010:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/create-workInProgress-a9d29e42934664c5af9693169675a336.png"},9824:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/createeffect-073b172fcbd01e018d9a706a4c3c2849.png"},6101:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/current-workInprogress-c80773136aecbec2d6363da842577631.png"},2106:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/fiber-tree-e4a6a0c1865d96121971e16bb77678bf.png"},997:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/fiber-cf82be2c42061005bc78de037e056f26.png"},3347:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/hostRootFiber-create-68f0b6b2792369a10162cbc4a250223b.png"},6:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/second-beginwork-children-a51fb069cdb1c646d4855415bda45184.png"},8340:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/second-cp-8e7369d7a1c136fcf20e5b7e75255095.png"},7401:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/update-2e6d622d1374b05c22e33ffacd71aaf8.png"},4737:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/workInProgress-A1-25adef339124ba6a855797050a0674f2.png"},7142:(e,n,r)=>{r.d(n,{Z:()=>t});const t=r.p+"assets/images/workInprogress-sibling-37c4c9c11e762f88cab82819a8886e9d.png"}}]);